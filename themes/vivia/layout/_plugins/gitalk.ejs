<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css">
<link rel="stylesheet" href="/css/gitalk-custom.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script>
<script src="https://cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js"></script>
<div id="gitalk-container"></div>
<script type="text/javascript">
  var gitalk = new Gitalk({
    clientID: '<%= theme.gitalk.ClientID %>',
    clientSecret: '<%= theme.gitalk.ClientSecret %>',
    repo: '<%= theme.gitalk.repo %>',
    owner: '<%= theme.gitalk.owner %>',
    admin: <%- JSON.stringify(theme.gitalk.adminUser) %>,
    id: md5(location.pathname),
    labels: '<%= theme.gitalk.labels %>'.split(',').filter(l => l),
    perPage: <%= theme.gitalk.perPage %>,
    pagerDirection: '<%= theme.gitalk.pagerDirection %>',
    createIssueManually: <%= theme.gitalk.createIssueManually %>,
    distractionFreeMode: <%= theme.gitalk.distractionFreeMode %>
  })
  gitalk.render('gitalk-container')
  
  // 强制统一 UI：在 Gitalk 渲染后修改 DOM，使其与未登录状态一致
  function unifyGitalkUI() {
    var container = document.querySelector('.gt-container')
    if (!container) return
    
    // 1. 将所有 gt-comment-block-2 改为 gt-comment-block-1
    var blocks = container.querySelectorAll('.gt-comment-block-2')
    blocks.forEach(function(block) {
      block.className = 'gt-comment-block-1'
    })
    
    // 2. 移除所有 gt-comment-admin 类
    var adminComments = container.querySelectorAll('.gt-comment-admin')
    adminComments.forEach(function(comment) {
      comment.classList.remove('gt-comment-admin')
    })
    
    // 3. 将编辑按钮替换为回复按钮
    var editBtns = container.querySelectorAll('.gt-comment-edit')
    editBtns.forEach(function(btn) {
      btn.className = 'gt-comment-reply'
      btn.title = 'Reply'
      btn.removeAttribute('href')
      btn.removeAttribute('target')
      btn.removeAttribute('rel')
      // 替换图标
      var svg = btn.querySelector('svg')
      if (svg) {
        svg.innerHTML = '<path d="M853.333333 341.333333L925.333333 269.333333C942.4 252.266667 942.4 222.133333 925.333333 209.333333L814.666667 98.666667C806.133333 90.133333 796 85.333333 785.333333 85.333333C774.666667 85.333333 763.2 90.133333 754.666667 98.666667L682.666667 170.666667L640 217.333333L806.666667 384L853.333333 341.333333Z M640 217.333333L85.333333 768L85.333333 938.666667L256 938.666667L806.666667 384L640 217.333333Z"></path>'
      }
    })
    
    // 4. 隐藏用户头像，显示 GitHub 图标
    var headerAvatars = container.querySelectorAll('.gt-header-avatar')
    headerAvatars.forEach(function(avatar) {
      avatar.style.display = 'none'
    })
    
    // 5. 确保 GitHub 图标显示
    var githubIcons = container.querySelectorAll('.gt-avatar-github')
    githubIcons.forEach(function(icon) {
      icon.style.display = 'inline-block'
    })
    
    // 6. 隐藏用户信息区域
    var userInfo = container.querySelector('.gt-user')
    if (userInfo) {
      userInfo.style.display = 'none'
    }
  }
  
  // 在 Gitalk 渲染完成后执行统一操作
  setTimeout(unifyGitalkUI, 1000)
  setTimeout(unifyGitalkUI, 2000)
  setTimeout(unifyGitalkUI, 3000)
  
  // 监听 DOM 变化，动态统一 UI
  var observer = new MutationObserver(function(mutations) {
    unifyGitalkUI()
  })
  
  setTimeout(function() {
    var container = document.getElementById('gitalk-container')
    if (container) {
      observer.observe(container, { childList: true, subtree: true })
    }
  }, 1000)
</script>
