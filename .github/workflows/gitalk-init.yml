name: Gitalk Comments Init

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  init-comments:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Labels and Issues
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
        run: |
          node << 'NODE_EOF'
          const { execSync } = require('child_process');
          const fs = require('fs');
          const path = require('path');

          const repo = process.env.REPO;

          // 创建标签
          const labels = [
            { name: 'gitalk', color: '0052CC', desc: 'Gitalk comments' },
            { name: 'links', color: '0E8A16', desc: 'Links page' },
            { name: 'post', color: 'F9D0C4', desc: 'Blog post' },
            { name: 'page', color: 'C5DEF5', desc: 'Static page' }
          ];

          console.log('Creating labels...');
          for (const label of labels) {
            try {
              execSync(`gh api --method POST -H "Accept: application/vnd.github+json" /repos/${repo}/labels -f name="${label.name}" -f color="${label.color}" -f description="${label.desc}"`, { stdio: 'ignore' });
              console.log(`Created label: ${label.name}`);
            } catch (e) {
              console.log(`Label ${label.name} already exists`);
            }
          }

          // 创建Links页面issue
          console.log('Creating issue for Links page...');
          try {
            execSync(`gh issue create --repo "${repo}" --title "Gitalk: Links 页面评论" --body "This issue is used to store comments for: links" --label "gitalk,links"`, { stdio: 'ignore' });
            console.log('Created issue for Links');
          } catch (e) {
            console.log('Issue for Links already exists');
          }

          // 扫描_posts目录
          console.log('Scanning posts directory...');
          const postsDir = 'source/_posts';
          if (fs.existsSync(postsDir)) {
            const files = fs.readdirSync(postsDir).filter(f => f.endsWith('.md'));
            for (const file of files) {
              const filepath = path.join(postsDir, file);
              const content = fs.readFileSync(filepath, 'utf8');
              const filename = file.replace('.md', '');
              
              // 提取title
              const titleMatch = content.match(/^title:\s*["']?([^"'\n]+)["']?/m);
              const title = titleMatch ? titleMatch[1].trim() : filename;
              
              console.log(`Creating issue for post: ${title}`);
              try {
                execSync(`gh issue create --repo "${repo}" --title "Gitalk: ${title}" --body "This issue is used to store comments for: ${filename}" --label "gitalk,post"`, { stdio: 'ignore' });
                console.log(`Created issue for ${filename}`);
              } catch (e) {
                console.log(`Issue for ${filename} already exists`);
              }
            }
          }

          // 扫描其他页面
          console.log('Scanning pages directory...');
          const sourceDir = 'source';
          if (fs.existsSync(sourceDir)) {
            const dirs = fs.readdirSync(sourceDir, { withFileTypes: true })
              .filter(d => d.isDirectory() && d.name !== '_posts' && d.name !== 'links');
            
            for (const dir of dirs) {
              const indexPath = path.join(sourceDir, dir.name, 'index.md');
              if (fs.existsSync(indexPath)) {
                const content = fs.readFileSync(indexPath, 'utf8');
                const titleMatch = content.match(/^title:\s*["']?([^"'\n]+)["']?/m);
                const title = titleMatch ? titleMatch[1].trim() : dir.name;
                
                console.log(`Creating issue for page: ${title}`);
                try {
                  execSync(`gh issue create --repo "${repo}" --title "Gitalk: ${title}" --body "This issue is used to store comments for: ${dir.name}" --label "gitalk,page"`, { stdio: 'ignore' });
                  console.log(`Created issue for ${dir.name}`);
                } catch (e) {
                  console.log(`Issue for ${dir.name} already exists`);
                }
              }
            }
          }

          console.log('Gitalk issues initialization completed!');
          NODE_EOF