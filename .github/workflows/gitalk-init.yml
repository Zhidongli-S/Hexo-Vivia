name: Gitalk Comments Init

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  init-comments:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Labels and Issues
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
        run: |
          node << 'NODE_EOF'
          const { execSync } = require('child_process');
          const fs = require('fs');
          const path = require('path');

          const repo = process.env.REPO;

          // 获取已存在的issues
          console.log('Fetching existing issues...');
          let existingIssues = [];
          try {
            const output = execSync(`gh issue list --repo "${repo}" --label "gitalk" --state all --json title,body --limit 100`, { encoding: 'utf8' });
            existingIssues = JSON.parse(output);
            console.log(`Found ${existingIssues.length} existing issues`);
          } catch (e) {
            console.log('No existing issues found');
          }

          // 检查是否已存在某个页面的issue
          function issueExists(pageId) {
            return existingIssues.some(issue => 
              issue.body && issue.body.includes(`for: ${pageId}`)
            );
          }

          // 创建标签
          const labels = [
            { name: 'gitalk', color: '0052CC', desc: 'Gitalk comments' },
            { name: 'links', color: '0E8A16', desc: 'Links page' },
            { name: 'post', color: 'F9D0C4', desc: 'Blog post' },
            { name: 'page', color: 'C5DEF5', desc: 'Static page' }
          ];

          console.log('Creating labels...');
          for (const label of labels) {
            try {
              execSync(`gh api --method POST -H "Accept: application/vnd.github+json" /repos/${repo}/labels -f name="${label.name}" -f color="${label.color}" -f description="${label.desc}"`, { stdio: 'ignore' });
              console.log(`Created label: ${label.name}`);
            } catch (e) {
              // 标签已存在
            }
          }

          let createdCount = 0;

          // 创建Links页面issue（如果不存在）
          if (!issueExists('links')) {
            console.log('Creating issue for Links page...');
            try {
              execSync(`gh issue create --repo "${repo}" --title "Gitalk: Links 页面评论" --body "This issue is used to store comments for: links" --label "gitalk,links"`, { stdio: 'ignore' });
              console.log('✓ Created issue for Links');
              createdCount++;
            } catch (e) {
              console.log('✗ Failed to create issue for Links');
            }
          } else {
            console.log('✓ Issue for Links already exists, skipping');
          }

          // 扫描_posts目录
          console.log('\nScanning posts directory...');
          const postsDir = 'source/_posts';
          if (fs.existsSync(postsDir)) {
            const files = fs.readdirSync(postsDir).filter(f => f.endsWith('.md'));
            for (const file of files) {
              const filepath = path.join(postsDir, file);
              const content = fs.readFileSync(filepath, 'utf8');
              const filename = file.replace('.md', '');
              
              // 提取title
              const titleMatch = content.match(/^title:\s*["']?([^"'\n]+)["']?/m);
              const title = titleMatch ? titleMatch[1].trim() : filename;
              
              // 检查是否已存在
              if (issueExists(filename)) {
                console.log(`✓ Issue for post "${title}" already exists, skipping`);
                continue;
              }
              
              console.log(`Creating issue for new post: ${title}`);
              try {
                execSync(`gh issue create --repo "${repo}" --title "Gitalk: ${title}" --body "This issue is used to store comments for: ${filename}" --label "gitalk,post"`, { stdio: 'ignore' });
                console.log(`✓ Created issue for ${filename}`);
                createdCount++;
              } catch (e) {
                console.log(`✗ Failed to create issue for ${filename}`);
              }
            }
          }

          // 扫描其他页面
          console.log('\nScanning pages directory...');
          const sourceDir = 'source';
          if (fs.existsSync(sourceDir)) {
            const dirs = fs.readdirSync(sourceDir, { withFileTypes: true })
              .filter(d => d.isDirectory() && d.name !== '_posts' && d.name !== 'links');
            
            for (const dir of dirs) {
              const indexPath = path.join(sourceDir, dir.name, 'index.md');
              if (fs.existsSync(indexPath)) {
                const content = fs.readFileSync(indexPath, 'utf8');
                const titleMatch = content.match(/^title:\s*["']?([^"'\n]+)["']?/m);
                const title = titleMatch ? titleMatch[1].trim() : dir.name;
                
                // 检查是否已存在
                if (issueExists(dir.name)) {
                  console.log(`✓ Issue for page "${title}" already exists, skipping`);
                  continue;
                }
                
                console.log(`Creating issue for new page: ${title}`);
                try {
                  execSync(`gh issue create --repo "${repo}" --title "Gitalk: ${title}" --body "This issue is used to store comments for: ${dir.name}" --label "gitalk,page"`, { stdio: 'ignore' });
                  console.log(`✓ Created issue for ${dir.name}`);
                  createdCount++;
                } catch (e) {
                  console.log(`✗ Failed to create issue for ${dir.name}`);
                }
              }
            }
          }

          console.log(`\n✅ Gitalk issues initialization completed! Created ${createdCount} new issues.`);
          NODE_EOF